<!DOCTYPE html>
<html lang="en">

<head>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,300,600|Open+Sans+Condensed:300' rel='stylesheet' type='text/css'>
    <title></title>

    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

    
     <!-- Optional CSS -->
    <!--
    <link rel="stylesheet" href="css/jquery-ui-1.10.4.custom.min.css">
    <link rel="stylesheet" href="css/jquery.ui.labeledslider.css">
    <link rel="stylesheet" href="css/jquery.zglossary.css">
    <link rel="stylesheet" href="css/owl.carousel.css">
    <link rel="stylesheet" href="css/jowl.default.css">
    <link rel="stylesheet" href="css/owl.theme.default.css">-->
    <link rel="stylesheet" href="css/globalStyle.css" />
    <link rel="stylesheet" href="css/styles.css" media="screen">
    <link rel="stylesheet" href="css/style-chosen.css">
    
    <style type="text/css">
    	.node rect {
 
		}
		
		.node text {
		  pointer-events: none;
		  font-size:10px;
		}
		
		.link {
		  fill: none;
		  stroke: #000;
		  stroke-opacity: .2;
		}
		
		.link:hover {
		  stroke-opacity: .5;
		}

    
    </style>
</head>
<body>

	<div id="altern">
    	<p>Unfortunately your browser cannot display this graphic. You might need to upgrade to a modern browser - Find out more information here <a href="https://www.gov.uk/help/browsers">https://www.gov.uk/help/browsers</a></p>
        <img src="images/alt.png"></img>
    </div>
    
    <div class="container-fluid">
           
          
           <div  class="row" id="graphic"></div>
               
           <div class="row footer">  
                 
           </div>
    </div> <!--end container-fluid-->
  
    
    <!-- Constant libraries / frameworks -->
    <script src="js/jquery-1.11.1.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
 	<script src="js/modernizr.custom.56904.js"></script>
    <script src="js/chosen.jquery.js"></script>
    <script src="js/d3.v3.min.js" charset="utf-8"></script>
    <script src="js/pym.js" charset="utf-8"></script>
	<script src="js/sankey.js"></script>
	<script></script>
    
<!--Optional libraries/frameworks-->
<!--
    
    <script src="js/jquery-ui-1.10.4.custom.min.js"></script>
    <script src="js/idangerous.swiper-2.1.min.js"></script>
    <script src="js/idangerous.swiper.hashnav.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.ui.labeledslider.js"></script>
    <script src="js/jquery.ui.touch-punch.min"></script>
    <script src="js/topojson.min.js"></script>

-->
<!--Main code-->
    
    <script>

		var graphic = $('#graphic');
		var keypoints = $('#keypoints');
		var footer = $(".footer");
		var pymChild = null;

		function drawGraphic(width) {
		   var threshold_md = 788;
		   var threshold_sm = dvc.optional.mobileBreakpoint; 
		  
		  	//set variables for chart dimensions dependent on width of #graphic
		    if (graphic.width() < threshold_sm) {        	
		            var margin = {top: dvc.optional.margin_sm[0], right: dvc.optional.margin_sm[1], bottom: dvc.optional.margin_sm[2], left: dvc.optional.margin_sm[3]}; 
					var width = graphic.width() - margin.left - margin.right;
		            var height = Math.ceil((width * dvc.optional.aspectRatio_sm[1]) / dvc.optional.aspectRatio_sm[0]) - margin.top - margin.bottom;
		    } else if (graphic.width() < threshold_md){
		        	var margin = {top: dvc.optional.margin_md[0], right: dvc.optional.margin_md[1], bottom: dvc.optional.margin_md[2], left: dvc.optional.margin_md[3]}; 
					var width = graphic.width() - margin.left - margin.right;
		            var height = Math.ceil((width * dvc.optional.aspectRatio_md[1]) / dvc.optional.aspectRatio_md[0]) - margin.top - margin.bottom;
		  	} else {
		        	var margin = {top: dvc.optional.margin_lg[0], right: dvc.optional.margin_lg[1], bottom: dvc.optional.margin_lg[2], left: dvc.optional.margin_lg[3]}
					var width = graphic.width() - margin.left - margin.right;
		            var height = Math.ceil((width * dvc.optional.aspectRatio_lg[1]) / dvc.optional.aspectRatio_lg[0]) - margin.top - margin.bottom;
			}

		    // clear out existing graphics
		    graphic.empty();
			keypoints.empty();
			footer.empty();
			

		   var colors = d3.scale.ordinal()
                  .domain(["PC", "PNFC", "MFI", "OFI", "ICPF", "CG", "LG", "HH+NPISH", "RoW", "unknown", "Currency", "Deposits", "Short term debt securities", "Long term debt securities", "Loans", "Equity and investment fund shares", "Insurance, pension and standardised guarantee schemes", "Financial derivatives"])
                  .range(["#A6CEE3", "#99CCFF", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#FFFF00", "#FF7F00", "#CAB2D6", "#6A3D9A", "#D0DCF0",  "#D0DCF0", "#D0DCF0",  "#D0DCF0", "#D0DCF0",  "#D0DCF0", "#D0DCF0",  "#D0DCF0", "#D0DCF0"]);
			
			//create svg  
		   	var svg = d3.select("#graphic").append("svg")
				.attr("width",  width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
			  	.append("g")
				.attr("transform", 	"translate(" + margin.left + "," + margin.top + ")");

	
			// Set the sankey diagram properties
			var sankey = d3.sankey()
				.nodeWidth(30)
				.nodePadding(5)
				.size([width, height])
				.nodes(graphic_data.nodes)
				.links(graphic_data.links)
				.layout(32);
	
			var path = sankey.link();
			
			// add in the links
			var link = svg.append("g").selectAll(".link")
				  .data(graphic_data.links)
				  .enter()
				  .append("path")
				  .attr("class", function (d) {
						return "link" + " " + d.liaIns;
					})
				  .attr("d", path)
				  .style("stroke-width", function(d) {
					    return Math.max(1, d.dy); 
					})
				  .style("stroke", function (d) {
						return colors(d.color);
					})
				  .sort(function(a, b) { return b.dy - a.dy; })
				  .on('mouseover',function() {
                    			d3.select(this)
								  .style("stroke-opacity", function (d) {
									// console.log(d.liaIns);
									
								d3.selectAll(".link").filter("." + d.liaIns)
									  .style("stroke-opacity", function (d) {
										var sel = d3.select(this);
										sel.moveToFront();
										return 0.9;
									  });
									  var sel = d3.select(this);
									  sel.moveToFront();
									return 0.9;
								  });
			
							  })
				    .on('mouseout',function() {
								d3.select(this)
								  .style("stroke-opacity", function (d) {
									// console.log(d.liaIns);
									d3.selectAll(".link").filter("." + d.liaIns)
									  .style("stroke-opacity", function (d) {
										return .1;
									  });
									return .1;
								  });
							  });
				  
		
			  // add in the nodes
			  var node = svg.append("g").selectAll(".node")
				  .data(graphic_data.nodes)
				.enter().append("g")
				  .attr("class", "node")
				  .attr("transform", function(d) { 
					  return "translate(" + d.x + "," + d.y + ")"; })
			   
			
				// add the rectangles for the nodes
			  node.append("rect")
				  .attr("height", function(d) { return d.dy; })
				  .attr("width", sankey.nodeWidth())
				  .style({ fill: function (d) {
              var name = d.name.replace(/ liability| asset|/gi, "");
              return d.color = colors(name);
            },
            stroke: function (d) {
              return d3.rgb(d.color).darker(2);
            }
          })
        //  .style("stroke-width", 0.1)
		
		
		
				// add in the title for the nodes
			  node.append("text")
				  .attr("x", -6)
				  .attr("y", function(d) { return d.dy / 2; })
				  .attr("dy", ".35em")
				  .attr("text-anchor", "end")
				  .attr("transform", null)
				  .text(function(d) { 
				  		 asset = d.name.replace(" asset", "");
						 liability =asset.replace(" liability", "");
						return liability; 
					})
				.filter(function(d) { return d.x <  width / 2; })
				  .attr("x", 6 + sankey.nodeWidth())
				  .attr("text-anchor", "start");
				
												
				//create link to source				
				d3.select(".footer").append("p")
					.text("Source: ")
					.append("a")
					.attr("href", dvc.essential.sourceURL)
					.attr("target", "_blank")
					.html(dvc.essential.sourceText);
						
			//use pym to calculate chart dimensions	
		    if (pymChild) {
		        pymChild.sendHeight();
		    }
		}// end drawGraphic

		//function to move path to front
		d3.selection.prototype.moveToFront = function() {
		  	return this.each(function(){
				this.parentNode.appendChild(this);
			});
		};


		
        
              


		//check whether browser can cope with svg	
		if (Modernizr.svg) {
		   d3.select("#altern").remove();
		   
		   //load config 
			d3.json("config.json", function(error, config) {
			dvc=config

				//d3.json("sankey-formatted.json", function(error, data) {
				d3.csv("A_D3_v2.csv", function(error, csvData) {	
					graphic_data=csvData;
					//console.log(data)
					
								
					csvData.forEach(function(d) {
						d.Y2006 = parseFloat(d.Y2006);
						d.Y2007 = parseFloat(d.Y2007);
						d.Y2008 = parseFloat(d.Y2008);
						d.Y2009 = parseFloat(d.Y2009);
						d.Y2010 = parseFloat(d.Y2010);
						d.Y2011 = parseFloat(d.Y2011);
						d.Y2012 = parseFloat(d.Y2012);
						d.Y2013 = parseFloat(d.Y2013);
						d.Y2014 = parseFloat(d.Y2014);
					});
					
		
					// Liabilities subtotals
					var liabilitySubTotals = d3.nest()
						.key(function(d) { return d.Liability; })
						.key(function(d) { return d.Instrument; })
						.rollup(function(values) { return {	"Y2006": d3.sum(values, function (d) {return d.Y2006;}),
															"Y2007": d3.sum(values, function (d) {return d.Y2007;}),
															"Y2008": d3.sum(values, function (d) {return d.Y2008;}),
															"Y2009": d3.sum(values, function (d) {return d.Y2009;}),
															"Y2010": d3.sum(values, function (d) {return d.Y2010;}),
															"Y2011": d3.sum(values, function (d) {return d.Y2011;}),
															"Y2012": d3.sum(values, function (d) {return d.Y2012;}),
															"Y2013": d3.sum(values, function (d) {return d.Y2013;}),
															"Y2014": d3.sum(values, function (d) {return d.Y2014;})} })
						.entries(csvData);
		
					// console.log(liabilitySubTotals);
		
		
		
		
					var links = [],
						nodes = [];
		
					liabilitySubTotals.forEach(function (d) {
						d.values.forEach(function (item) {
							nodes.push({ "name": d.key + " liability"});
							links.push({ "source": d.key + " liability", 
										"target": item.key, 
										"Y2006": item.values.Y2006, 
										"Y2007": item.values.Y2007, 
										"Y2008": item.values.Y2008, 
										"Y2009": item.values.Y2009, 
										"Y2010": item.values.Y2010, 
										"Y2011": item.values.Y2011, 
										"Y2012": item.values.Y2012, 
										"Y2013": item.values.Y2013, 
										"Y2014": item.values.Y2014, 
										"liability": d.key + " liability", 
										"instrument": item.key, 
										"color": d.key});
						})
						
					}); 
		
					// console.log(links);
		
			
					//get all source and target into nodes
					//will reduce to unique in the next step
					//also get links in object form
					csvData.forEach(function (d) {
						nodes.push({ "name": d.Instrument });
						nodes.push({ "name": d.Asset + " asset"});
						links.push({ "source": d.Instrument, "target": d.Asset + " asset", "Y2006": d.Y2006, "Y2007": d.Y2007, "Y2008": d.Y2008, "Y2009": d.Y2009, "Y2010": d.Y2010, "Y2011": d.Y2011, "Y2012": d.Y2012, "Y2013": d.Y2013, "Y2014": d.Y2014, "liability": d.Liability + " liability", "instrument": d.Instrument, "color": d.Liability});
					}); 
		
		
					// Reduce to unique set of nodes
					nodes = d3.keys(d3.nest()
						.key(function (d) { return d.name; })
						.map(nodes));
		
					// console.log(nodes);
		
					// Substitute source and target with node id
					links.forEach(function (d) {
						d.source = nodes.indexOf(d.source);
						d.target = nodes.indexOf(d.target);
				  d.liability = nodes.indexOf(d.liability);
				  d.instrument = nodes.indexOf(d.instrument);
					});
					// console.log(links);
		
					// Get back nodes as an array of objects
					nodes.forEach(function (d, i) {
					nodes[i] = { "name": d };
					});
		
		
					 linksX = [];
					var year = "Y2014" // change this to change the year
					links.forEach(function (d) {
		
						if (d[year] != 0) {
							linksX.push({
					  "source": d.source,
					  "target": d.target,
					  "value": d[year],
					"color": d.color,
					"liaIns": "L" + d.liability + d.instrument,
					});
						}
					
				});
		
			  // console.log(linksX);
				graphic_data  = {"nodes" : nodes, "links" : linksX};
				
					//use pym to create iframed chart dependent on specified variables
					pymChild = new pym.Child({ renderCallback: drawGraphic});
					
				})
			})

		} else {
			 $('.container-fluid').remove();
			 //use pym to create iframe containing fallback image (which is set as default)
			 pymChild = new pym.Child();
			 
			// console.log(pymChild);
			 
			if (pymChild) {
		        pymChild.sendHeight();
		    }
		}
    </script>
</body>
</html>
