<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Sankey Diagram</title>

  <style>
    body {
     	font-family:"Calibri (Body)";
    }
    #selector {
    	width: 150px;
    	text-align: center;
    	font-family:"Calibri (Body)";
    	font-size: 16px;
    }
    #item {
    	font-family:"Calibri (Body)";
    }
/*    #chart {
			display: block;
			margin-left: auto; 
			margin-right: auto;
			width: 960px;
			height: 600px;
    } */
    .row {
      width: 100%;
      margin: 0 auto;
    }   
    #Legend {
      margin-top: 0px;
      display: inline-block;
      width: 20%; 
      height: 100%;
      vertical-align: top;
      font-family:"Calibri (Body)";
      font-size: 12px;
    }
    #chart {
      margin-top: 0px;
      display: inline-block;
      width: 75%; 
      height: 100%;
    } 
    .node rect {
			fill-opacity: .9;
			shape-rendering: crispEdges;
    }
    .link {
			fill: none;
			stroke-opacity: .15;
    }
/*    .link:hover {
      stroke-opacity: .7;
    }*/
    text {
      font-family:"Calibri (Body)";
      font-size: 12px;
    }
    title {
    	text-align: center;
    }
  </style>
</head>
<body>

<div class ="description">
    <table>
      <tr>
        <td>
          <select id="selector">
            <option id="item" value="Y2006">Year 2006</option>
            <option id="item" value="Y2007">Year 2007</option>
            <option id="item" value="Y2008">Year 2008</option>
            <option id="item" value="Y2009">Year 2009</option>
            <option id="item" value="Y2010">Year 2010</option>
            <option id="item" value="Y2011">Year 2011</option>
            <option id="item" value="Y2012">Year 2012</option>
            <option id="item" value="Y2013">Year 2013</option>
            <option id="item" value="Y2014">Year 2014</option>
          </select>
        </td>
      </tr>
    </table>
  </div>
  <br>
<div class= "row">
  <div id="Legend">
    <div class = "description">
    <br>
    <p style = "font-size: 16px;"> Asset/Liability Legend: </p>
    <table style = "border-spacing: 5px;">
    <tr>
        <td style = "background-color: #A6CEE3; text-align: center;">PC</td>
        <td>Public Corporation</td>
      </tr>
      <tr>
        <td style = "background-color: #99CCFF; text-align: center;">PNFC</td>
        <td>Private Non-Financial Corporation</td>
      </tr>
      <tr>
        <td style = "background-color: #B2DF8A; text-align: center;">MFI</td>
        <td>Monetary Financial Institutions</td>
      </tr>
      <tr>
        <td style = "background-color: #33A02C; text-align: center;">OFI</td>
        <td>Other Financial Intermediaries and Financial Auxiliaries</td>
      </tr>
      <tr>
        <td style = "background-color: #FB9A99; text-align: center;">ICPF</td>
        <td>Insurance Corporations and Pension Funds</td>
      </tr>
      <tr>
        <td style = "background-color: #E31A1C; text-align: center;">CG</td>
        <td>Central Government</td>
      </tr>
      <tr>
        <td style = "background-color: #FFFF00; text-align: center;">LG</td>
        <td>Local Government</td>
      </tr>
      <tr>
        <td style = "background-color: #FF7F00; text-align: center;">HH+NPISH</td>
        <td>Households and None-Profit Institutions Serving Households</td>
      </tr>
      <tr>
        <td style = "background-color: #CAB2D6; text-align: center;">RoW</td>
        <td>Rest of the World</td>
      </tr>
      <tr>
        <td style = "background-color: #6A3D9A; text-align: center;">Unknown</td>
        <td>Unknown</td>
      </tr>
    </table>
    </div>
  </div>
  <div id="chart"></div>
</div>

<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<script src='http://timelyportfolio.github.io/rCharts_d3_sankey/js/sankey.js' type='text/javascript'></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<script>

	var margin = {top: 10, right: 10, bottom: 10, left: 10};
  var width = 1000 - margin.left - margin.right;
  var height = 600 - margin.top - margin.bottom;

	var colors = d3.scale.ordinal()
                  .domain(["PC", "PNFC", "MFI", "OFI", "ICPF", "CG", "LG", "HH+NPISH", "RoW", "Unknown", "Currency", "Deposits", "Short term debt securities", "Long term debt securities", "Loans", "Equity and investment fund shares", "Insurance, pension and standardised guarantee schemes", "Financial derivatives"])
                  .range(["#A6CEE3", "#99CCFF", "#B2DF8A", "#33A02C", "#FB9A99", "#E31A1C", "#FFFF00", "#FF7F00", "#CAB2D6", "#6A3D9A", "#8D9CB3",  "#8D9CB3", "#8D9CB3",  "#8D9CB3", "#8D9CB3",  "#8D9CB3", "#8D9CB3",  "#8D9CB3", "#8D9CB3"]);

  var legend = d3.scale.ordinal()
                  .domain(["PC", "PNFC", "MFI", "OFI", "ICPF", "CG", "LG", "HH+NPISH", "RoW", "Unknown"])
                  .range(["Public Corporation", "Private Non-Financial Corporation", "Monetary Financial Institutions", "Other Financial Intermediaries and Financial Auxiliaries", "Insurance Corporations and Pension Funds", "Central Government", "Local Government", "Households and None-Profit Institutions Serving Households", "Rest of the World", "Unknown"])

  var formatNumber = d3.format("0,.0f"),    // zero decimal places
      format = function(d) { return formatNumber(d) + " Â£ million"; };

  var svg = d3.select("#chart")
  					.append("svg")
          	.attr({
            	"width": width + margin.left + margin.right,
            	"height": height + margin.top + margin.bottom
          	})
          	.append("g")
          	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");




  // Load the data
  d3.csv("A_D3_v2.csv", function(error, csvData) {

			
			csvData.forEach(function(d) {
				d.Y2006 = parseFloat(d.Y2006);
				d.Y2007 = parseFloat(d.Y2007);
				d.Y2008 = parseFloat(d.Y2008);
				d.Y2009 = parseFloat(d.Y2009);
				d.Y2010 = parseFloat(d.Y2010);
				d.Y2011 = parseFloat(d.Y2011);
				d.Y2012 = parseFloat(d.Y2012);
				d.Y2013 = parseFloat(d.Y2013);
				d.Y2014 = parseFloat(d.Y2014);
			});
			

			// Liabilities subtotals
			var liabilitySubTotals = d3.nest()
				.key(function(d) { return d.Liability; })
				.key(function(d) { return d.Instrument; })
				.rollup(function(values) { return {	"Y2006": d3.sum(values, function (d) {return d.Y2006;}),
													"Y2007": d3.sum(values, function (d) {return d.Y2007;}),
													"Y2008": d3.sum(values, function (d) {return d.Y2008;}),
													"Y2009": d3.sum(values, function (d) {return d.Y2009;}),
													"Y2010": d3.sum(values, function (d) {return d.Y2010;}),
													"Y2011": d3.sum(values, function (d) {return d.Y2011;}),
													"Y2012": d3.sum(values, function (d) {return d.Y2012;}),
													"Y2013": d3.sum(values, function (d) {return d.Y2013;}),
													"Y2014": d3.sum(values, function (d) {return d.Y2014;})} })
				.entries(csvData);

			// console.log(liabilitySubTotals);




			var links = [],
			    nodes = [];

			liabilitySubTotals.forEach(function (d) {
				d.values.forEach(function (item) {
					nodes.push({ "name": d.key + " Liability"});
					links.push({"source": d.key + " Liability", 
								"target": item.key, 
								"Y2006": item.values.Y2006, 
								"Y2007": item.values.Y2007, 
								"Y2008": item.values.Y2008, 
								"Y2009": item.values.Y2009, 
								"Y2010": item.values.Y2010, 
								"Y2011": item.values.Y2011, 
								"Y2012": item.values.Y2012, 
								"Y2013": item.values.Y2013, 
								"Y2014": item.values.Y2014, 
								"liability": d.key + " Liability", 
								"instrument": item.key, 
								"color": d.key});
				})
			    
			}); 

			// console.log(links);

    
			//get all source and target into nodes
			//will reduce to unique in the next step
			//also get links in object form
			csvData.forEach(function (d) {
			    nodes.push({ "name": d.Instrument });
			    nodes.push({ "name": d.Asset + " Asset"});
			    links.push({ "source": d.Instrument, 
							"target": d.Asset + " Asset", 
							"Y2006": d.Y2006, 
							"Y2007": d.Y2007, 
							"Y2008": d.Y2008, 
							"Y2009": d.Y2009, 
							"Y2010": d.Y2010, 
							"Y2011": d.Y2011, 
							"Y2012": d.Y2012, 
							"Y2013": d.Y2013, 
							"Y2014": d.Y2014, 
							"liability": d.Liability + " Liability", 
							"instrument": d.Instrument, 
							"color": d.Asset});
			}); 


			// Reduce to unique set of nodes
			nodes = d3.keys(d3.nest()
                .key(function (d) { return d.name; })
                .map(nodes));

			// console.log(nodes);

			// Substitute source and target with node id
			links.forEach(function (d) {
	    		d.source = nodes.indexOf(d.source);
	    		d.target = nodes.indexOf(d.target);
          d.liability = nodes.indexOf(d.liability);
          d.instrument = nodes.indexOf(d.instrument);
			});
			// console.log(links);

			// Get back nodes as an array of objects
			nodes.forEach(function (d, i) {
    		nodes[i] = { "name": d };
			});


			var linksX = [];
			var year = "Y2006"
			links.forEach(function (d) {

				if (d[year] != 0) {
					linksX.push({
	          "source": d.source,
	          "target": d.target,
	          "value": d[year],
            "color": d.color,
            "liaIns": "L" + d.liability + d.instrument,
	        });
				}
	        
	  	});

      // console.log(linksX);

	  // Sankey default params
	  var sankey = d3.sankey()
          			.nodeWidth(30)
          			.nodePadding(12)
          			.size([width, height])
          			.nodes(nodes)
          			.links(linksX)
          			.layout(32);
  	
    // Path data generator.
  	var path = sankey.link();

	  var link = svg.append("g")
	  							.selectAll(".link")
					        .data(linksX)
					        .enter()
					        .append("path")
                  .attr("class", function (d) {
                    return "link" + " " + d.liaIns;
                  })
					        .attr({"d": path })
					        .style("stroke-width", function (d) {
					          return Math.max(1, d.dy);
					    		})
                  .style("stroke", function (d) {
                    return colors(d.color);
                  })
                  .sort(function(a, b) { return b.dy - a.dy; })
                  .on('mouseover',function() {

                    d3.select(this)
                      .style("stroke-opacity", function (d) {
                        // console.log(d.liaIns);
                        d3.selectAll(".link").filter("." + d.liaIns)
                          .style("stroke-opacity", function (d) {
                            return .9;
                          });
                        return .9;
                      });
                  })
                  .on('mouseout',function() {
                    d3.select(this)
                      .style("stroke-opacity", function (d) {
                        // console.log(d.liaIns);
                        d3.selectAll(".link").filter("." + d.liaIns)
                          .style("stroke-opacity", function (d) {
                            return .15;
                          });
                        return .15;
                      });
                  });
  

  var node = svg.append("g").selectAll(".node")
          .data(nodes)
          .enter()
          .append("g")
          .attr({
            "class": "node",
            transform: function (d) {
              return "translate(" + d.x + "," + d.y + ")";
            }
          })
         
		 
  node.append("rect")
          .attr({
            "height": function (d) {
              return d.dy;
            },
            "width": sankey.nodeWidth()
          })
          .style({ fill: function (d) {
              var name = d.name.replace(/ Liability| Asset|/gi, "");
              return d.color = colors(name);
            },
            stroke: function (d) {
              return d3.rgb(d.color).darker(2);
            }
          })
         
   node.append("text")
          .attr("x", -6)
          .attr("y", function (d) { return d.dy / 2; })
          .attr("dy", ".35em")
          .attr("text-anchor", "end")
          .attr("transform", null)
          .text(function (d) { return d.name; })
        .filter(function (d) { return d.x < width / 2; })
          .attr("x", 6 + sankey.nodeWidth())
          .attr("text-anchor", "start");


          $('#selector').on('change', function() {
            // alert( this.value ); // 

            selectedValue = this.value;
            console.log(selectedValue);

            updateSankey(selectedValue);

          });


          function updateSankey(year) {
            var linksX = [];

              links.forEach(function (d) {

                if (d[year] != 0) {
                  linksX.push({
                    source: d.source,
                    target: d.target,
                    "value": d[year],
                    "color": d.color,
                    "liaIns": "L" + d.liability + d.instrument,
                  });
                }
                  
              });

              // console.log(linksX);


              sankey
                .nodeWidth(30)
                .nodePadding(12)
                .size([width, height])
                .nodes(nodes)
                .links(linksX)
                .layout(32);
				
              path = sankey.link();

              d3.selectAll(".link")
                .data(linksX, function(d) {
                  return d.source.name + d.target.name;
                })
                .transition()
                .duration(1000) 
                .attr("d", path)
                .style("stroke-width", function(d) { 
                  return Math.max(1, d.dy);
				 })
               
 

          // add the rectangles for the nodes
          d3.selectAll(".node").data(nodes)
            .transition()
            .duration(1000)
            .attr("transform", function(d) {
              return "translate(" + d.x + "," + d.y + ")";
            })

          d3.selectAll("rect").data(nodes)
            .transition()
            .duration(1000)
            .attr({
            "height": function (d) {
              return d.dy;
            },
            "width": sankey.nodeWidth()
            })
            .style({  fill: function (d) {
                      var name = d.name.replace(/ Liability| Asset|/gi, "");
                      return d.color = colors(name);
                    },
                      stroke: function (d) {
                      return d3.rgb(d.color).darker(2);
                    }
            });


         

          d3.selectAll("text")
            .data(nodes)
            .transition()
            .duration(1000)
            .attr("x", -6)
          .attr("y", function (d) { return d.dy / 2; })
          .attr("dy", ".35em")
          .attr("text-anchor", "end")
          .attr("transform", null)
          .text(function (d) { return d.name; })
        .filter(function (d) { return d.x < width / 2; })
          .attr("x", 6 + sankey.nodeWidth())
          .attr("text-anchor", "start");


          }




}) // close csv reader

</script>

</body>
</html>