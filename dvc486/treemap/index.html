<!DOCTYPE html>
<html lang="en">

<head>

    <title>Trade - Exports treemap</title>

    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="css/styles.css" media="screen">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/css/select2.min.css" rel="stylesheet" />

<style>
body{
	max-width:945px;
}

#svgEle{
	width:100%;
}

text {
  pointer-events: none;
}

.grandparent text {
  /*font-weight: bold;*/
  fill: #606060;
  font-size:1.8em;
}

rect {
  /*fill: none;*/
  stroke: #fff;
}

.grandparent{
/*	pointer-events:none;*/
}


rect.parent,
.grandparent rect {
  stroke-width: 2px;
  fill: none;
}

.grandparent line {
  stroke: #606060;
  stroke-width: 1px;
}

.btn{
	font-size:13px
}

.children rect.parent,
.grandparent rect {
  cursor: pointer;
}

.children rect.parent {
  fill: #bbb;
  fill-opacity: .2;
}

.children:hover rect.child {
  fill: #bbb;
}

*[code*=c1_], *[code*=c2_], *[code*=c3_], *[code*=c4_], *[code*=c5_] {
	fill:teal;
}


.depth text{
	fill:white;
}

#blurb{
	pointer-events:none;
	line-height: 2.2em;
	font-size:1em;
	font-weight: 600;
}


#txt2{
	font-weight:200;
}

@media (max-width: 500px) {

}


@media (min-width: 501px) {

}



@media (min-width: 939px) {

}


@media (min-width: 1200px) {

}

.horizLine{
	border-bottom:1px solid #B9B9B9;
	padding-bottom:5px;
	margin:0px 0px 5px -5px;
}





.btn-ons {
  color: #6f6f6f;
  background-color: #ffffff;
  border-color: #D3D3D3;
}
.btn-ons:hover,
.btn-ons:focus,
.btn-ons.focus,
.btn-ons:active,
.btn-ons.active,
.open > .dropdown-toggle.btn-ons {
  color: #6f6f6f;
  background-color: #E7E7E7;
  border-color: #D3D3D3;
}

hr {
  margin-top: 0px;
  margin-bottom: 3px;
  border: 0;
  border-top: 1px solid #dddddd;
}

#intro{
	display:none;
}

#social{
	top:5px;
}

.social {
			padding-top:5px;
			padding-left:5px;
			float:right;
			opacity:0.5;
			cursor:pointer;
		}

		.social:hover {
			opacity:1;

		}


		.social {

		}

		#embedrow {
			padding-bottom:5px;
			margin:5px;
			border-bottom:1px solid #d3d3d3;
			border-top:1px solid #d3d3d3;
		}


		#close {
			padding-bottom:3px;
		}

		#allDivs{
			margin:auto;
		}

#ieMsg{
	width: 940px;
    margin: 0 auto;
}
#suptext {
	padding:20px 20px 20px 20px;
	width:900px;
	background-color:#F2EEF5;
}

#suptext p{
	margin:0px 20px 10px 20px;
	font-family: Helvetica, Arial, sans-serif;
    font-size:14px;
	color:#8064A0;

}

#suptext a{
	font-family: Helvetica, Arial, sans-serif;
    font-size:14px;
	color:#8064A0;

}

#suptext h1{
	margin:0px;
	font-family: Helvetica, Arial, sans-serif;
    font-size:24px;
	color:#8064A0;
}

#thumbNail{
	top:0px;
	left:0px;
}

.img-responsive,
.thumbnail > img,
.thumbnail a > img,
.carousel-inner > .item > img,
.carousel-inner > .item > a > img {
  width: 100% !important;


}

#source{
	font-size:12px;
}

.item{
	width:80px;
	height:80px;
}
	

#selectNav {
	margin-top:10px;
	left:0px;
	width:80%;
	height:45px;
	background-color:rgba(255,255,255,0.8);
	z-index:1;
}
	
.select2-container--default .select2-selection--single{
	border-color: #d3d3d3!important;
}


	.y text, .x text{
		font-size: 12px;
		fill:"#666";
	}	
	
	.x line{
		stroke:#ccc;
		stroke-width: 1px;
		shape-rendering: crispEdges;
	}
	
	.x path{
		stroke:none;
		fill:none;
	}
	.y path{
		fill:none;
		stroke-width:2px;
			stroke:#666;
	}	
	
	.bars rect{
		stroke:none;
	}
	
</style>



</head>
  <body id="childt">



<div class="container-fluid">
           <div id="main-wrapper">

          <div id="mainContent" style="display:none">

				<div id="blurb" class="row">
					<text id ="txt2"></tspan>
					<text id ="txt3"></tspan>
				</div>
				<div class="row">
					<button type="button" id="upBtn" class="nav btn btn-ons ">
					  <span class="glyphicon glyphicon-upload" aria-hidden="true"></span> Up a level
					</button>
					<button type="button" id="topBtn" class="nav btn btn-ons ">
					  <span class="glyphicon glyphicon-upload" aria-hidden="true"></span> Back to top
					</button>
					<div id="selectNav"> 
						
					</div>
			  </div>

              <div class="row" >
                    <div id="chart" class="col-sm-6"></div>
                    <div id="bar_chart" class="col-sm-6"></div>

              </div>

           <div id="source">
	Source: <a href="https://www.ons.gov.uk/economy/nationalaccounts/balanceofpayments/datasets/9geographicalbreakdownofthecurrentaccountthepinkbook2016" target="_blank">Geographical breakdown of the current account, The Pink Book: 2017</a>, ONS
</div>


        </div>
         <div id="ieMsg" style="display:none">
                    <div id="suptext">
                      <h1>Browser requirements</h1>
                      <p><b>For a safer, faster, better experience online you should upgrade your browser. You would have been able to play with this lovely interactive graphic below. <a href="https://www.gov.uk/support/browsers" target="_blank">Find out more about browsers</a></b>
                      </p>
                    </div>
                      <img id="thumbNail" src="exports.png">
                </div>
       </div>
</div><!--end of .container-fluid-->

<script src="https://cdn.ons.gov.uk/vendor/jquery/1.12.4/jquery.min.js"></script>
<script src="js/modernizr.custom.56904.js"></script>
<script src="https://cdn.ons.gov.uk/vendor/bootstrap/3.3.7/js/bootstrap.min.js" charset="utf-8"></script>
<script src="https://cdn.ons.gov.uk/vendor/pym/1.3.2/pym.js" charset="utf-8"></script>
<script src="js/base.js" charset="utf-8"></script>
<script src="js/DataStructures.Tree.js" charset="utf-8"></script>
<script src="https://cdn.ons.gov.uk/vendor/d3/3.5.17/d3.min.js" charset="utf-8"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.6-rc.0/js/select2.min.js"></script>




<script>

	if (Modernizr.inlinesvg= true ){

			$("#main-wrapper").fadeIn(1000);
			$("#mainContent").fadeIn(1000);

		}else{
				$("#ieMsg").fadeIn(1000);
		}




	pymChild = new pym.Child();




	var	transitioning;
	var widthCalc;
	var heightCalc;
	var params;

	getSizes();


	$(window).resize(function () {
		  if(window.innerWidth != bwidth) {
			getSizes();
		  }
	});


	function getSizes() {

		bodywidth = d3.select("body").style("width");
		bwidth = bodywidth.replace('px', '');
		divwidth = d3.select("#chart").style("width");
		width = divwidth.replace('px', '') - 30;
		if(bwidth >= 767) {
			
			fullheight = 400;
			ratiovar = 0.5;
			
		} else {
			
			var url = (window.location != window.parent.location) ;
			if(url == false){
					ratiovar = 0.2;
					windowheight = window.innerHeight;

					if(windowheight<=500) {
						
						 fullheight = window.innerHeight-100;
					} else if (windowheight >500 && windowheight <=800) {
						fullheight = window.innerHeight - 350;
					} else if (windowheight >800 && windowheight <=2000) {
						fullheight = window.innerHeight - 450;
					}
			} else {
				ratiovar = 0.2;
					windowheight = 350;
					fullheight =400;
			}
		}

		d3.select("#svgEle").remove();
		makeChart(width, fullheight);

	}

	
	function create_dropdown(){
		
		d3.select("#selectNav").selectAll("*").remove();
		// Build option menu for occupations
			var optns = d3.select("#selectNav").append("div").attr("id","sel").append("select")
				.attr("id","areaselect")
				.attr("style","width:98%")
				.attr("class","chosen-select");

			optns.append("option")
				// .attr("value","first")
				// .text("");

			optns.selectAll("p").data(trade).enter().append("option")
				.attr("value", function(d){ return d.id})
				//.attr("id",function(d){return d.id})
				.html(function(d){ return d.name});


			 $('#areaselect').select2({placeholder:"Total",allowClear:true,dropdownParent:$('#sel')})

			 //$('#areaselect').on('input',function(){console.log("click")})

			$('#areaselect').on('change',function(){
				if(typeof params != 'undefined' /*||  params =="c0"*/) {
					console.log("here")
					backToTop();
					
				} else {
					console.log(" or here")
					backToTop();
					hierarchy = [];
					
					$('#areaselect').val().split("_").forEach(function(d,i){ 
						if(i!=0){ 
							hierarchy.push(hierarchy[i-1].concat("_"+d)) 
						} else {
							hierarchy.push(d)
						}
					})
					storyArray = hierarchy;
					params = hierarchy;
					selectedView = storyArray.join().replace(/,/g , "/")

					$(storyArray).each(function(i){
						setTimeout(function(){
							storyId = "#"+storyArray[i];
							//console.log(d3.select(storyId)[0][0])
							simulateClick(d3.select(storyId)[0][0]);
						}, 760*i);
					});
				}	
				
				
			})
		
	}
	
	
	var graphic = d3.select('#bar_chart');
	
	function draw_barchart(){
			create_dropdown();
		
		
		   var threshold_md = 788;
		   var threshold_sm = dvc.optional.mobileBreakpoint; 
		  
		  	//set variables for chart dimensions dependent on width of #graphic
		    if (parseInt(graphic.style("width")) < threshold_sm) {        	
		            var margin = {top: dvc.optional.margin_sm[0], right: dvc.optional.margin_sm[1], bottom: dvc.optional.margin_sm[2], left: dvc.optional.margin_sm[3]}; 
					var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
		            var height = dvc.essential.barHeight_sm_md_lg[0] * 5 - margin.top - margin.bottom;
		    } else if (parseInt(graphic.style("width")) < threshold_md){
		        	var margin = {top: dvc.optional.margin_md[0], right: dvc.optional.margin_md[1], bottom: dvc.optional.margin_md[2], left: dvc.optional.margin_md[3]}; 
					var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
		            var height = dvc.essential.barHeight_sm_md_lg[0] * 5 - margin.top - margin.bottom;
		  	} else {
		        	var margin = {top: dvc.optional.margin_lg[0], right: dvc.optional.margin_lg[1], bottom: dvc.optional.margin_lg[2], left: dvc.optional.margin_lg[3]}
					var chart_width = parseInt(graphic.style("width")) - margin.left - margin.right;
		            var height = dvc.essential.barHeight_sm_md_lg[0] * 5 - margin.top - margin.bottom;
			}
		
			// clear out existing graphics
		    graphic.selectAll("*").remove();
		
			xBar = d3.scale.linear()
		        .range([ 0, chart_width]);

			yBar = d3.scale.ordinal()
				.rangeRoundBands([0, height], .3)
			
		
			selected_country = trade.filter(function(d) { if(d.id == "c0"){ /*console.log(d);*/ return d;} });
			
			 // parse data into columns
		    top5_countries =[];
		    
			top5_countries.push(selected_country[0].rank1)
			top5_countries.push(selected_country[0].rank2)
			top5_countries.push(selected_country[0].rank3)
			top5_countries.push(selected_country[0].rank4)
			top5_countries.push(selected_country[0].rank5)
			
			top5_trade_vals =[];
		    
			top5_trade_vals.push(selected_country[0].trade_val1)
			top5_trade_vals.push(selected_country[0].trade_val2)
			top5_trade_vals.push(selected_country[0].trade_val3)
			top5_trade_vals.push(selected_country[0].trade_val4)
			top5_trade_vals.push(selected_country[0].trade_val5)
			
		    yBar.domain(top5_countries);
		
			var yBarAxis = d3.svg.axis()
		        .scale(yBar)
		        .orient("left")
		    
		    var xBarAxis = d3.svg.axis()
		        .scale(xBar)
		        .orient('bottom')
				.tickSize(-height, 0, 0);
		    			    
		
			var xBarDomain = [0, d3.max(top5_trade_vals)];
			xBar.domain(xBarDomain)
			
			var svg = d3.select('#bar_chart').append('svg')
						//.attr("id","chart")
        				.style("background-color","#fff")
				        .attr("width", chart_width + margin.left + margin.right)
				        .attr("height", height + margin.top + margin.bottom /*+30*/)
				        .append("g")
				        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
				
					svg.append("rect")
						.attr("class","svgRect")
						.attr("width", chart_width)
						.attr("height", height)
						.attr("fill","transparent")
			    
				    svg.append('g')
				        .attr('class', 'x axis')
				        .attr("transform", "translate(0, "+height+")")
				        .call(xBarAxis).append("text")
						 .attr("y", 25)
						 .attr("x",chart_width)
						 .attr("dy", ".71em")
						 .style("text-anchor", "start")
						 .attr("font-size","12px")
 						 .attr("fill","#666")
						 .text(dvc.essential.xAxisLabel);

					svg.append('g').attr("class","bars").selectAll('rect')
						.data(top5_trade_vals)
						.enter()
						.append('rect')
						.attr("fill", "teal")
						.attr("opacity", "0.8")
						.attr("width", function(d,i) { return 0 + Math.abs(xBar(d) - xBar(0)); })
						.attr("x", function(d,i) { return xBar(Math.min(0, d)); })
						.attr("y", function(d,i) { return yBar(top5_countries[i]); })
						.attr("height", yBar.rangeBand())
	


		//create y axis, if x axis doesn't start at 0 drop x axis accordingly	
			svg.append('g')
				.attr('class', 'y axis')
				.call(yBarAxis);



			
	} //end draw_barchart

	function update_barchart(selection){
		selected_country = trade.filter(function(d) { if(d.id == selection){ return d;} });
			
			 // parse data into columns
		    top5_countries =[];
		    
			top5_countries.push(selected_country[0].rank1)
			top5_countries.push(selected_country[0].rank2)
			top5_countries.push(selected_country[0].rank3)
			top5_countries.push(selected_country[0].rank4)
			top5_countries.push(selected_country[0].rank5)
			
			top5_trade_vals =[];
		    
			top5_trade_vals.push(selected_country[0].trade_val1)
			top5_trade_vals.push(selected_country[0].trade_val2)
			top5_trade_vals.push(selected_country[0].trade_val3)
			top5_trade_vals.push(selected_country[0].trade_val4)
			top5_trade_vals.push(selected_country[0].trade_val5)	
	
			yBar.domain(top5_countries);
	
			var yBarAxis = d3.svg.axis()
		        .scale(yBar)
		        .orient("left")
		    
		    var xBarAxis = d3.svg.axis()
		        .scale(xBar)
		        .orient('bottom')
				.tickSize(-height, 0, 0);
			
			var xBarDomain = [0, d3.max(top5_trade_vals)];
			
			xBar.domain(xBarDomain);
			
		  
		     
			d3.select(".y").transition().delay(500).call(yBarAxis);
			
			d3.select(".x").transition().duration(500).call(xBarAxis);
				
		d3.select("#bar_chart").selectAll(".bars")
			.selectAll("rect")
			.data(top5_trade_vals)
			.transition()
			.duration(500)
			.attr("width", function(d,i) { 
				 return 0 + Math.abs(xBar(d) - xBar(0)); 
			})
		

	} //end update_barchart

	function makeChart(width, fullheight) {

	 margin = {top: 0, right: 0, bottom: 0, left: 0}
        formatNumber = d3.format(",.1f"),


		atTop=true,
		level = 0,
		levelArray = Array(level);

    height = fullheight - margin.top - margin.bottom;

     x = d3.scale.linear()
        .domain([0, width])
        .range([0, width]);

     y = d3.scale.linear()
        .domain([0, height])
        .range([0, height]);

    treemap = d3.layout.treemap()
        .children(function(d, depth) { return depth ? null : d._children; })
        .sort(function(a, b) { return a.size - b.size; })
        .ratio(height / width * ratiovar * (1 + Math.sqrt(5)))
		.value(function(d) { return d.size; })
        .round(false);

     svg = d3.select("#chart")
		.append("svg")
		.attr("id", "svgEle")
		.attr("width", width + "px")
		.attr("height", height + "px")
		//.attr("viewBox", "0 0 "+width+" "+ (height))
		.attr("preserveAspectRatio", "xMidYMid meet")
        .style("margin-left", -margin.left + "px")
        .style("margin.right", -margin.right + "px")
      .append("g")
	  	.attr("id", "tree")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")
       // .style("shape-rendering", "crispEdges");

     grandparent = svg.append("g")
        .attr("class", "grandparent")
	 	.append("rect")
	 	.attr("id", "gparent")
		.attr("y", -margin.top)
		.attr("width", width)
		.attr("height", margin.top);


    d3.csv("data_to_convert.csv", function(data){
		
		data.forEach(function(d) {
			d.size = Number(d.size); 
			d.var2 = Number(d.var2); 
        });

		
var tree = DataStructures.Tree.createFromFlatTable(data),
           root = tree.toSimpleObject(function(objectToDecorate, originalNode) {
                objectToDecorate.size = originalNode.size;
                if (objectToDecorate.children && objectToDecorate.children.length == 0) {
                    delete objectToDecorate.children;
                }
                return objectToDecorate;
            });
//console.log(JSON.stringify(root));

		dataset = root;
		 initialize(root);
		 accumulate(root);
		 layout(root);
		 display(root);

	d3.select("#blurb").select("#txt3").html("Total exports: £"+formatNumber(dataset.var2)+" billion");
		d3.json("config.json", function(error, config) {
				dvc=config
			d3.csv("trade.csv", function(data){
				trade = data
				//console.log(trade)
				draw_barchart();
			}) // end trade csv
		}) //end json config
	}); //end treemap csv load



	}


      function initialize(root) {
        root.x = root.y = 0;
        root.dx = width;
	    root.dy = height;
        root.depth = 0;
      }

      // Aggregate the values for internal nodes. This is normally done by the
      // treemap layout, but not here because of our custom implementation.
      // We also take a snapshot of the original children (_children) to avoid
      // the children being overwritten when when layout is computed.
      function accumulate(d) {
		   //console.log('accumulate')
        return (d._children = d.children)
            ? d.size = d.children.reduce(function(p, v) { return p + accumulate(v); }, 0)
            : d.size;

      }

      // Compute the treemap layout recursively such that each group of siblings
      // uses the same size (1×1) rather than the dimensions of the parent cell.
      // This optimizes the layout for the current zoom state. Note that a wrapper
      // object is created for the parent node for each group of siblings so that
      // the parent’s dimensions are not discarded as we recurse. Since each group
      // of sibling was laid out in 1×1, we must rescale to fit using absolute
      // coordinates. This lets us use a viewport to zoom.
      function layout(d) {

        if (d._children) {

         treemap.nodes({_children: d._children});
          d._children.forEach(function(c) {
            c.x = d.x + c.x * d.dx;
            c.y = d.y + c.y * d.dy;
            c.dx *= d.dx;
            c.dy *= d.dy;
            c.parent = d;

            layout(c);
          });
        }
      }

      function display(d) {

        grandparent
            .datum(d.parent)
            .on("click", transition)
//            .select("text")
//            .text(desc(d))

		d3.select("#titleText")
            .datum(d.parent)
           // .text(desc(d))

        var g1 = svg.insert("g", ".grandparent")
            .datum(d)
            .attr("class", "depth");

        var g = g1.selectAll("g")
            .data(d._children)
          .enter().append("g");

        g.filter(function(d) { return d._children; })
            .classed("children", true)
            .on("click", transition);

        g.selectAll(".child")
            .data(function(d) { return d._children || [d]; })
          .enter().append("rect")
            .attr("class", "child")
			.attr("code",function(d) { return d.id} )
			.attr("desc",function(d) { return d.name} )
			.attr("id",function(d) { return d.id} )
			.attr("vals",function(d) { return d.size} )
			.attr("realvals",function(d) { return d.var2} )
			.on("mouseover", mouseover)
			.on("mouseout", mouseout)
            .call(rect);

        g.append("rect")
            .attr("class", "parent")
			.attr("desc",function(d) { return d.name} )
			.attr("id",function(d) { return d.id} )
			.attr("vals",function(d) { return d.size} )
			.attr("realvals",function(d) { return d.var2} )
			.on("mouseover", mouseover)
			.on("mouseout", mouseout)
            .call(rect);

       g.append("text")
			.attr("class", "parentLabels")
            .attr("dy", "1em")
            .text(function(d) { return d.name+" £"+formatNumber(d.var2)+" billion"; })
			.call(resize)
            .call(text);



        function transition(d) {
			if(d3.select(this).attr("id") != "gparent"){
				selectedArray.push(d3.select(this).select('.parent').attr("id"))
				selectedView = selectedArray.join().replace(/,/g , "/")

				window.location.hash = encodeURI(selectedView);
			} else {
						selectedArray.splice(-1,1)
						selectedView = selectedArray.join().replace(/,/g , "/")

						window.location.hash = encodeURI(selectedView)
			}



          if (transitioning || !d) return;
          transitioning = true;

          var g2 = display(d),
              t1 = g1.transition().duration(400),
              t2 = g2.transition().duration(400);

          // Update the domain only after entering new elements.
          x.domain([d.x, d.x + d.dx]);
          y.domain([d.y, d.y + d.dy]);

          // Enable anti-aliasing during the transition.
          svg.style("shape-rendering", null);

          // Draw child nodes on top of parent nodes.
          svg.selectAll(".depth").sort(function(a, b) { return a.depth - b.depth; });

          // Fade-in entering text.
          g2.selectAll("text").style("fill-opacity", 0);


          // Transition to the new view.
          t1.selectAll("rect").call(rect);
		  t1.selectAll("text").call(text).style("fill-opacity", 1);
         // t1.selectAll(".childLabels").call(text).style("fill-opacity",1);
          t1.selectAll(".parentLabels").call(text).style("fill-opacity",1);

          t2.selectAll("rect").call(rect);
		  t2.selectAll("text").call(resize).call(text).style("fill-opacity", 1);
		//  t2.selectAll(".childLabels").call(text).call(resize2).style("fill-opacity", 1);
		  t2.selectAll(".parentLabels").call(resize).call(text).style("fill-opacity", 1);


          // Remove the old node when the transition is finished.
          t1.remove().each("end", function() {
            svg.style("shape-rendering", "crispEdges");
            transitioning = false;
          });

			myClass = $(this).attr("class");

			if(myClass=="children"){
				level = level+1;
				levelArray = Array(level);
			} else {
				level = level-1;
				levelArray = Array(level);
			}

		}

        return g;
		g.each( function(d,i) {
			d3.selectAll(".children").selectAll("text")
				.data(d._children).enter().append("text")
				.attr("class", "childLabels")
				.attr("dy", "0.5em")
				.text(function(d){ return d.name;});
			})
      }

	  function resize(text, width){

			text.each(function(d,i) {

				var text = d3.select(this).style("font-size", function(d) {
						return Math.sqrt((d.widthCalc*d.heightCalc))/ Math.log(this.getComputedTextLength())*0.45 + "px";
				})
			});
	  };

	  function text(text, width) {
		  	text.each(function(d,i) {
				var text = d3.select(this),
					words = text.text().split(/\s+/).reverse(),
					word,
					line = [],
					y = text.attr("y"),
					dy = parseFloat(text.attr("dy")),
					tspan = text.text(null).append("tspan")/*.attr("x", 0).attr("y", y)*/.attr("dy",  "1em");

				while (word = words.pop()) {
				  line.push(word+" ");
				  tspan.text(line.join(" "));

				 if (tspan.node().getComputedTextLength() >  d.widthCalc-10) {
					line.pop();
					tspan.text(line.join(" "));
					line = [word+" "];

					tspan = text.append("tspan").attr("x", function(d) { return x(d.x) + 6; }).attr("dy",  dy + "em").text(word+" ");

				  }
				 }
			  });

       d3.selectAll(".parentLabels").attr("y", function(d) { return y(d.y) + 6; })
      					   			.attr("x", function(d) { return x(d.x) + 6; });
	  }


	  function rect(rect) {
		rect.attr("x", function(d) { return x(d.x); })
            .attr("y", function(d) { return y(d.y); })
      		.attr("width", function(d) {
				   widthCalc = x(d.x + d.dx) - x(d.x);

				  d["widthCalc"] = widthCalc;
				  return widthCalc;
        	})
            .attr("height", function(d) {
				 heightCalc =y(d.y + d.dy) - y(d.y);
				 d["heightCalc"] = heightCalc;
				  return heightCalc;
     		})
	  }

//      function desc(d) {
//		return d.parent
//            ? desc(d.parent) + " > " + d.desc
//            : d.desc;
//      }


	function mouseover (d){

			var	selectClass = $(this).attr('desc');
			var	selectValue = $(this).attr('realvals');
	//	console.log($(this).attr('name'))
			d3.select("#blurb").select("#txt3").html(selectClass+": £"+formatNumber(selectValue)+" billion")
				
			//$('#areaselect').val($(this).attr("id")); // Select the option with a value of '1'
			//$('#areaselect').trigger('change'); // Notify any JS components that the value changed
			d3.select(".select2-selection__placeholder").text($(this).attr("desc"))
			update_barchart($(this).attr("id"));
		
	};

	function mouseout (){
		//console.log(dataset)	
		d3.select("#blurb").select("#txt3").html("Total exports: £"+/*formatNumber*/(dataset.var2)+" billion");
		d3.select(".select2-selection__placeholder").text("Total")
			
	};

	function simulateClick(elem /* Must be the element */) {
		var evt = document.createEvent("MouseEvents");
		evt.initMouseEvent(
			"click", /* type */
			true, /* canBubble */
			true, /* cancelable */
			window, /* view */
			0, /* detail */
			0, /* screenX */
			0, /* screenY */
			0, /* clientX */
			0, /* clientY */
			false, /* ctrlKey */
			false, /* altKey */
			false, /* shiftKey */
			false, /* metaKey */
			0, /* button */
			null); /* relatedTarget */
		elem.dispatchEvent(evt);
	}

	d3.select("#upBtn").on('click', function() {
	    	simulateClick(grandparent[0][0]);

	});

	d3.select("#topBtn").on('click', function() {
	    	backToTop();
	});



	setTimeout( function(){
	 	if (pymChild) {
       		pymChild.sendHeight();



			var url = decodeURI(window.location.hash);


			selectedArray = []
			if (url == ""){
				selectedView = "c0"
			} else {
				params = url.split("/");
				params[0] = params[0].replace("#", "")
				storyArray = params;
				selectedView = storyArray.join().replace(/,/g , "/")
				//console.log(selectedView)
				$(storyArray).each(function(i){

					setTimeout(function(){
						storyId = "#"+storyArray[i];
						simulateClick(d3.select(storyId)[0][0]);
						//$("#areaselect").val(storyId).trigger('change.select2');
						$('#areaselect').val(storyArray[i]); // Select the option with a value of '1'
						$('#areaselect').trigger('change'); // Notify any JS components that the value changed
					}, 760*i);
				});

			}

		}
	}, 700)








function backToTop (){

			$(levelArray).each(function(i){
				setTimeout(function(){
					simulateClick(grandparent[0][0]);
				},760*i);
			});
};



	function updateHash() {

	}



    </script>


<script>


		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-37894017-1']);
		  _gaq.push(['_trackPageview']);


		  (function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();

</script>

</body>
</html>
